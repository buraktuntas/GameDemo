using UnityEngine;
using Mirror;
using System.Collections.Generic;

namespace TacticalCombat.Building
{
    /// <summary>
    /// Valheim-style structural integrity system
    /// YapÄ±lar zemin veya gÃ¼Ã§lÃ¼ desteklerden uzaklaÅŸtÄ±kÃ§a zayÄ±flar
    /// </summary>
    public class StructuralIntegrity : NetworkBehaviour
    {
        [Header("Stability Settings")]
        [SerializeField] private float maxStability = 100f; // Zemine baÄŸlÄ± yapÄ±lar
        [SerializeField] private float stabilityLossPerMeter = 10f; // Her metre iÃ§in kayÄ±p
        [SerializeField] private float minStability = 10f; // Bu deÄŸerin altÄ±nda yÄ±kÄ±lÄ±r
        [SerializeField] private float checkRadius = 2.5f; // KomÅŸu yapÄ±larÄ± kontrol iÃ§in
        
        [Header("Visual Feedback")]
        [SerializeField] private Renderer structureRenderer;
        [SerializeField] private bool showStabilityColor = true;
        
        [SyncVar(hook = nameof(OnStabilityChanged))]
        private float currentStability = 100f;
        
        [SyncVar]
        private bool isGrounded = false; // Zemine baÄŸlÄ± mÄ±?
        
        private static List<StructuralIntegrity> allStructures = new List<StructuralIntegrity>();
        
        // Stability renk kodu (Valheim tarzÄ±)
        private static Color blueStability = new Color(0.3f, 0.6f, 1f);    // 100-80: Ã‡ok saÄŸlam
        private static Color greenStability = new Color(0.3f, 1f, 0.3f);   // 80-60: SaÄŸlam
        private static Color yellowStability = new Color(1f, 1f, 0.3f);    // 60-40: Orta
        private static Color orangeStability = new Color(1f, 0.6f, 0.2f);  // 40-20: ZayÄ±f
        private static Color redStability = new Color(1f, 0.2f, 0.2f);     // 20-0: YÄ±kÄ±lmak Ã¼zere

        private void Awake()
        {
            if (structureRenderer == null)
                structureRenderer = GetComponentInChildren<Renderer>();
        }

        private void Start()
        {
            allStructures.Add(this);
            
            if (isServer)
            {
                // Server'da stability hesapla
                Invoke(nameof(CalculateStability), 0.5f);
            }
        }

        private void OnDestroy()
        {
            allStructures.Remove(this);
        }

        [Server]
        private void CalculateStability()
        {
            // 1. Zemine baÄŸlÄ± mÄ± kontrol et
            isGrounded = CheckGrounded();
            
            if (isGrounded)
            {
                // Zemine direkt baÄŸlÄ± = maksimum stabilite
                currentStability = maxStability;
            }
            else
            {
                // Zemine baÄŸlÄ± deÄŸilse, en yakÄ±n destek noktasÄ±nÄ± bul
                float supportDistance = FindNearestSupport();
                
                if (supportDistance < 0)
                {
                    // HiÃ§ destek yok! YÄ±kÄ±lmalÄ±
                    currentStability = 0f;
                }
                else
                {
                    // Destek mesafesine gÃ¶re stabilite hesapla
                    float stabilityLoss = supportDistance * stabilityLossPerMeter;
                    currentStability = Mathf.Max(minStability, maxStability - stabilityLoss);
                }
            }
            
            // Ã‡ok dÃ¼ÅŸÃ¼k stabilitede yÄ±kÄ±l
            if (currentStability < minStability)
            {
                CollapseStructure();
            }
            else
            {
                // KomÅŸu yapÄ±larÄ± da gÃ¼ncelle (zincirleme etki)
                UpdateNeighborStabilities();
            }
        }

        [Server]
        private bool CheckGrounded()
        {
            // Zemin kontrolÃ¼ (raycast aÅŸaÄŸÄ±)
            Vector3 origin = transform.position;
            float checkDistance = 1.5f;
            
            if (Physics.Raycast(origin, Vector3.down, out RaycastHit hit, checkDistance))
            {
                // Zemin layer'Ä±na Ã§arptÄ± mÄ±?
                if (hit.collider.gameObject.layer == LayerMask.NameToLayer("Default") ||
                    hit.collider.CompareTag("Ground"))
                {
                    return true;
                }
            }
            
            return false;
        }

        [Server]
        private float FindNearestSupport()
        {
            float nearestDistance = float.MaxValue;
            bool foundSupport = false;
            
            // YakÄ±ndaki tÃ¼m yapÄ±larÄ± tara
            foreach (var other in allStructures)
            {
                if (other == this || other == null) continue;
                
                float distance = Vector3.Distance(transform.position, other.transform.position);
                
                // KomÅŸu mu? (checkRadius iÃ§inde)
                if (distance <= checkRadius)
                {
                    // KomÅŸu yapÄ± zeminde veya saÄŸlam mÄ±?
                    if (other.isGrounded || other.currentStability > 50f)
                    {
                        foundSupport = true;
                        
                        // En yakÄ±n destek mesafesini hesapla
                        if (other.isGrounded)
                        {
                            // Zemine baÄŸlÄ± yapÄ±dan mesafe
                            nearestDistance = Mathf.Min(nearestDistance, distance);
                        }
                        else
                        {
                            // BaÅŸka bir destekten gelen mesafe (zincirleme)
                            float chainDistance = distance + (maxStability - other.currentStability) / stabilityLossPerMeter;
                            nearestDistance = Mathf.Min(nearestDistance, chainDistance);
                        }
                    }
                }
            }
            
            return foundSupport ? nearestDistance : -1f;
        }

        [Server]
        private void UpdateNeighborStabilities()
        {
            // YakÄ±ndaki yapÄ±larÄ± gÃ¼ncelle
            foreach (var other in allStructures)
            {
                if (other == this || other == null) continue;
                
                float distance = Vector3.Distance(transform.position, other.transform.position);
                
                if (distance <= checkRadius)
                {
                    // KomÅŸu yapÄ±nÄ±n stabilitesini yeniden hesapla
                    other.Invoke(nameof(CalculateStability), 0.1f);
                }
            }
        }

        [Server]
        private void CollapseStructure()
        {
            Debug.Log($"ğŸ’¥ Structure collapsed due to low stability: {gameObject.name}");
            
            // YÄ±kÄ±lma efekti (opsiyonel: partikÃ¼l, ses)
            // TODO: PartikÃ¼l efekti ekle
            
            // KomÅŸu yapÄ±larÄ± gÃ¼ncelle (zincirleme yÄ±kÄ±lma)
            UpdateNeighborStabilities();
            
            // YapÄ±yÄ± yok et
            NetworkServer.Destroy(gameObject);
        }

        // Client-side gÃ¶rsel feedback
        private void OnStabilityChanged(float oldStability, float newStability)
        {
            if (showStabilityColor && structureRenderer != null)
            {
                UpdateVisualFeedback(newStability);
            }
        }

        private void UpdateVisualFeedback(float stability)
        {
            Color stabilityColor = GetStabilityColor(stability);
            
            // Materyal rengini gÃ¼ncelle
            if (structureRenderer.material != null)
            {
                structureRenderer.material.color = stabilityColor;
            }
        }

        private Color GetStabilityColor(float stability)
        {
            float normalizedStability = stability / maxStability;
            
            if (normalizedStability > 0.8f) return blueStability;      // 100-80
            if (normalizedStability > 0.6f) return greenStability;     // 80-60
            if (normalizedStability > 0.4f) return yellowStability;    // 60-40
            if (normalizedStability > 0.2f) return orangeStability;    // 40-20
            return redStability;                                       // 20-0
        }

        // Debug gÃ¶rselleÅŸtirme
        private void OnDrawGizmosSelected()
        {
            // KomÅŸu yapÄ± arama yarÄ±Ã§apÄ±
            Gizmos.color = Color.yellow;
            Gizmos.DrawWireSphere(transform.position, checkRadius);
            
            // Zemin kontrolÃ¼
            Gizmos.color = Color.blue;
            Gizmos.DrawLine(transform.position, transform.position + Vector3.down * 1.5f);
        }

        // Public getter'lar
        public float GetCurrentStability() => currentStability;
        public bool IsGrounded() => isGrounded;
    }
}


